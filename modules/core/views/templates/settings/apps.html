{% extends "base-desktop.html" %}

{% block title %}Manage Apps{% endblock %}

{% block additional_styles %}
<style>
/* Only keep styles that can't be achieved with Bootstrap */
.app-manager-grid {
    display: grid;
    gap: 1.5rem;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
}

.app-manager-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bs-gray-100);
    border-radius: 0.5rem;
}

.app-version-badge {
    font-size: 0.75rem;
    padding: 0.125rem 0.375rem;
    background: var(--bs-gray-100);
    border-radius: 0.25rem;
}

.alert.hiding {
    opacity: 0;
    transform: translateY(-100%);
    transition: all 0.3s ease-out;
}
</style>
{% endblock %}

{% block content %}
<div class="card shadow-sm mx-4 my-3">
    <div class="card-body p-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-4">
                <li class="breadcrumb-item">
                    <a href="{{ url_for('core_bp.settings') }}" class="text-decoration-none text-secondary">
                        <i class="fas fa-cog me-2"></i> {{ _("Settings") }}
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    <i class="fas fa-puzzle-piece me-2 text-primary"></i> {{ _("App Manager") }}
                </li>
            </ol>
        </nav>

        <div class="mb-4">
            <h2 class="d-flex align-items-center gap-3 mb-2">
                <i class="fas fa-puzzle-piece text-primary"></i> 
                {{ _("Manage Applications") }}
            </h2>
            <p class="text-muted mb-0">{{ _("Enable, disable, or remove installed applications") }}</p>
        </div>

        <div class="app-manager-grid">
            {% for mod in modules %}
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body p-4">
                        <div class="d-flex gap-3 mb-3">
                            <div class="app-manager-icon flex-shrink-0">
                                <i class="{{ mod.icon_class }}" style="color: {{ mod.color }}"></i>
                            </div>
                            <div class="flex-grow-1 min-width-0">
                                <div class="d-flex align-items-center gap-2 mb-2">
                                    <h3 class="h5 mb-0">{{ mod.name }}</h3>
                                    <span class="app-version-badge">v{{ mod.version }}</span>
                                </div>
                                <p class="text-secondary small mb-2">{{ mod.description }}</p>
                                <p class="text-muted small mb-0">{{ mod.long_description }}</p>
                            </div>
                        </div>
                        
                        {% if mod.type != 'System' and mod.name != 'People' %}
                            <div class="d-flex justify-content-end align-items-center gap-3 pt-3 border-top">
                                <div class="form-check form-switch p-0 m-0">
                                    <input class="form-check-input" type="checkbox" 
                                           role="switch"
                                           id="toggle-{{ mod.name|lower }}"
                                           {% if mod.enabled %}checked{% endif %}
                                           onchange="toggleModule('{{ mod.name }}', this.checked)">
                                </div>
                                <button class="btn btn-link text-danger p-0 border-0" onclick="confirmRemove('{{ mod.name }}')">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
// Add toast container to the page
document.body.insertAdjacentHTML('beforeend', `
    <div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>
`);

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    
    toast.className = `alert alert-${type} fade show shadow-sm`;
    toast.textContent = message;
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('hiding');
        setTimeout(() => container.removeChild(toast), 300);
    }, 3000);
}

async function toggleModule(moduleName, enabled) {
    try {
        const response = await fetch('/api/modules/toggle', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                module: moduleName,
                enabled: enabled
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to toggle module');
        }
        
        const data = await response.json();
        showToast(data.message);
        await reloadAfterRestart();
        
    } catch (error) {
        console.error('Error:', error);
        showToast('Failed to toggle module', 'error');
    }
}

async function restartApplication() {
    try {
        const response = await fetch('/api/restart', {
            method: 'GET'
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error('Failed to restart application');
        }
        
        if (data.status === 'warning') {
            showToast(data.message, 'warning');
            return;
        }

        await reloadAfterRestart();
        
    } catch (error) {
        console.error('Error restarting application:', error);
        showToast('Failed to restart application', 'error');
    }
}

async function reloadAfterRestart() {
    showToast('{{ _("Waiting for server to restart...") }}');
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    try {
        await waitForServer();
        showToast('{{ _("Server restarted, reloading page...") }}');
        window.location.reload(true);
    } catch (error) {
        showToast('{{ _("Server failed to restart") }}', 'error');
    }
}

async function waitForServer(retries = 20) {
    for (let i = 0; i < retries; i++) {
        try {
            await new Promise(resolve => setTimeout(resolve, 500));
            const response = await fetch('/login', { method: 'GET' });
            if (response.ok) {
                await new Promise(resolve => setTimeout(resolve, 500));
                return true;
            }
        } catch (e) {
            console.log('Server not ready, retrying...');
        }
    }
    throw new Error('Server failed to restart');
}

function confirmRemove(moduleName) {
    if (confirm(`{{ _("Are you sure you want to remove") }} ${moduleName}? {{ _("This cannot be undone") }}.`)) {
        removeModule(moduleName);
    }
}

async function removeModule(moduleName) {
    // Implementation for module removal
}

function showDetails(moduleName) {
    // Implementation for showing module details
}
</script>

{% endblock %} 