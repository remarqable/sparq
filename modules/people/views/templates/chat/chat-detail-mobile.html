{% extends "base-mobile.html" %}

{% block title %}{{ _("Chat") }} - #{{ channel.name }}{% endblock %}

{% block additional_styles %}
<link rel="stylesheet" href="{{ url_for('people_bp.static', filename='css/people.css') }}">
<style>
    .chat-container {
        height: calc(100vh - var(--header-height) - var(--footer-height) - var(--safe-area-inset-top) - var(--safe-area-inset-bottom));
        display: flex;
        flex-direction: column;
    }

    .chat-header {
        display: grid;
        grid-template-columns: 44px 1fr 44px;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .back-button {
        color: #0d6efd;
        font-size: 1.25rem;
        padding: 0.5rem;
        margin: -0.5rem;
        line-height: 1;
        text-decoration: none;
    }

    .header-info {
        text-align: center;
    }

    .header-info h1 {
        font-size: 1.25rem;
        margin: 0;
        font-weight: 500;
    }

    .header-info .description {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .message {
        display: flex;
        flex-direction: column;
        max-width: 85%;
    }

    .message.sent {
        align-self: flex-end;
    }

    .message.received {
        align-self: flex-start;
    }

    .message-content {
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        background: #f8f9fa;
        margin-bottom: 0.25rem;
    }

    .message.sent .message-content {
        background: #0d6efd;
        color: white;
        border-bottom-right-radius: 0.25rem;
    }

    .message.received .message-content {
        border-bottom-left-radius: 0.25rem;
    }

    .message-meta {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.75rem;
        color: #6c757d;
    }

    .message.sent .message-meta {
        justify-content: flex-end;
    }

    .message-input {
        padding: 1rem;
        border-top: 1px solid rgba(0,0,0,0.1);
        background: white;
    }

    .message-form {
        display: flex;
        gap: 0.5rem;
    }

    .message-form textarea {
        flex: 1;
        border: 1px solid #dee2e6;
        border-radius: 1.5rem;
        padding: 0.75rem 1rem;
        resize: none;
        max-height: 100px;
        line-height: 1.2;
    }

    .message-form button {
        background: none;
        border: none;
        color: #0d6efd;
        padding: 0.5rem;
        font-size: 1.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    @media (prefers-color-scheme: dark) {
        .chat-header {
            border-color: rgba(255,255,255,0.1);
        }

        .header-info .description {
            color: #adb5bd;
        }

        .message-content {
            background: #2d2d2d;
        }

        .message.sent .message-content {
            background: #0d6efd;
        }

        .message-meta {
            color: #adb5bd;
        }

        .message-input {
            border-color: rgba(255,255,255,0.1);
            background: #1a1a1a;
        }

        .message-form textarea {
            background: #2d2d2d;
            border-color: #444;
            color: white;
        }
    }

    .back-transition {
        view-transition-name: back;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container" x-data="chatDetail" x-init="initializeChat">
    <div class="chat-header">
        <a href="{{ url_for('people_bp.chat') }}" class="back-button" 
           onclick="document.documentElement.classList.add('back-transition')">
            <i class="fas fa-chevron-left"></i>
        </a>
        <div class="header-info">
            <h1><span class="channel-prefix">#</span>{{ channel.name }}</h1>
            <div class="description">{{ channel.description }}</div>
        </div>
        <div></div>
    </div>

    <div class="chat-messages" x-ref="chatMessages" x-html="messages"></div>

    <div class="message-input">
        <form class="message-form" @submit.prevent="sendMessage">
            <textarea 
                x-model="messageContent" 
                placeholder="{{ _('Message in #') }}{{ channel.name }}"
                rows="1"
                @keydown.enter.prevent="sendMessage"></textarea>
            <button type="submit">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('chatDetail', () => ({
        socket: null,
        messages: '',
        messageContent: '',
        channelName: '{{ channel.name }}',
        currentUserId: {{ current_user.id }},
        isLoading: true,

        initializeChat() {
            this.socket = io();
            this.socket.on('connect', () => {
                this.socket.emit('join', { channel: this.channelName });
            });

            this.socket.on('chat_changed', (data) => {
                if (data.channel === this.channelName) {
                    this.loadMessages();
                }
            });

            this.loadMessages();
        },

        async loadMessages() {
            try {
                const response = await fetch(`/people/chat/channels/${this.channelName}/messages`);
                if (!response.ok) throw new Error('Failed to load messages');
                
                const html = await response.text();
                this.messages = html;
                
                this.$nextTick(() => {
                    this.scrollToBottom();
                });
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        },

        scrollToBottom() {
            const chatMessages = this.$refs.chatMessages;
            if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        },

        async sendMessage() {
            if (!this.messageContent.trim()) return;

            const formData = new FormData();
            formData.append('content', this.messageContent);
            formData.append('channel', this.channelName);
            
            try {
                const response = await fetch('/people/chat/create', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text);
                }

                this.messageContent = '';
            } catch (error) {
                alert('Error sending message: ' + error.message);
            }
        }
    }));
});
</script>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
{% endblock %} 