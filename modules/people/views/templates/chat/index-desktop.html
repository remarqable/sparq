{% extends "base.html" %}

{% block title %}{{ _('Company Chat') }}{% endblock %}

{% block app_class %}people-app{% endblock %}

{% block additional_styles %}
<link rel="stylesheet" href="{{ url_for('people_bp.static', filename='css/people.css') }}">
<link rel="stylesheet" href="{{ url_for('people_bp.static', filename='css/chat.css') }}">
{% endblock %}

{% block content %}
<div class="d-flex">
    {% include 'people_nav.html' with context %}
    
    <div class="content-wrapper flex-grow-1">
        <!-- Add meta tags for initialization -->
        <meta name="user-id" content="{{ current_user.id }}">
        <meta name="default-channel" content="{{ default_channel.name }}">
        <meta name="default-channel-description" content="{{ default_channel.description }}">
        
        <!-- API endpoints -->
        <meta name="api-urls" content='{{ {
            "create_message": url_for("people_bp.create_chat"),
            "create_channel": url_for("people_bp.create_channel"),
            "get_messages": url_for("people_bp.get_channel_messages", channel_name=":channel"),
            "mark_read": url_for("people_bp.mark_channel_read", channel_name=":channel"),
            "delete_message": "/people/chat/:id",
            "delete_channel": url_for("people_bp.delete_channel", channel_name=":channel"),
            "toggle_pin": "/people/chat/:id/pin"
        } | tojson | safe }}'>
        
        <!-- Channel data for JavaScript initialization -->
        <meta name="channel-data" content='{"channels": [
            {% for channel in channels %}
            {
                "id": {{ channel.id }},
                "name": "{{ channel.name }}",
                "description": "{{ channel.description }}",
                "unreadCount": {{ ChatMessageState.get_unread_count(current_user.id, channel.id) }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ]}'>

        <div class="content-card" x-data="chatApp" x-init="initializeApp" @delete-message.window="deleteMessage">
            <div class="chat-container">
                <div class="chat-layout">
                    <!-- Channel Sidebar -->
                    <aside class="chat-sidebar">
                        <div class="sidebar-header">
                            <h3>{{ _('Channels') }}</h3>
                            {% if current_user.is_admin %}
                            <button class="btn btn-sm btn-link" data-bs-toggle="modal" data-bs-target="#newChannelModal">
                                <i class="fas fa-plus"></i>
                            </button>
                            {% endif %}
                        </div>

                        <div class="channel-list">
                            {% for channel in channels %}
                            <div class="channel" 
                                 :class="{ 'active': currentChannel === '{{ channel.name }}' }"
                                 x-data="{ id: {{ channel.id }}, name: '{{ channel.name }}' }">
                                <div class="channel-content" @click="switchChannel(name, id)">
                                    <div class="channel-name">
                                        <span class="channel-prefix">#</span> {{ channel.name }}
                                    </div>
                                </div>
                                <div class="channel-meta">
                                    <span class="unread-badge" 
                                          x-show="getUnreadCount(id) > 0" 
                                          x-text="getUnreadCount(id)"></span>
                                    {% if current_user.is_admin and channel.name != 'general' %}
                                    <div class="channel-actions">
                                        <div class="dropdown" x-data="{ open: false }">
                                            <button class="btn btn-link btn-sm channel-options" 
                                                    type="button" 
                                                    @click.stop="open = !open"
                                                    :aria-expanded="open">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end" 
                                                :class="{ 'show': open }" 
                                                @click.outside="open = false">
                                                <li><a class="dropdown-item" href="#" @click.prevent="editChannel(name, id); open = false">
                                                    <i class="fas fa-edit me-2"></i>{{ _('Edit Channel') }}
                                                </a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item text-danger" href="#" @click.prevent="confirmDeleteChannel(name); open = false">
                                                    <i class="fas fa-trash-alt me-2"></i>{{ _('Delete Channel') }}
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </aside>

                    <!-- Main Chat Area -->
                    <main class="chat-main">
                        <header class="chat-header">
                            <div class="chat-header-top">
                                <div class="chat-header-info">
                                    <h2><span class="channel-prefix">#</span><span x-text="currentChannel"></span></h2>
                                </div>
                                <div class="chat-header-actions">
                                    <button class="btn btn-link pin-filter" 
                                            :class="{ 'active': showPinnedOnly }"
                                            @click="togglePinFilter">
                                        <i class="fas fa-thumbtack"></i> {{ _('Pins') }}
                                        <span class="pin-count" x-text="pinnedMessagesCount" x-show="pinnedMessagesCount > 0"></span>
                                    </button>
                                    <div class="search-box">
                                        <i class="fas fa-search"></i>
                                        <input type="text" 
                                               x-model="searchQuery"
                                               placeholder="{{ _('Search messages...') }}" 
                                               class="form-control"
                                               @input="handleSearch">
                                    </div>
                                </div>
                            </div>
                            <p class="channel-description" x-text="currentChannelDescription"></p>
                        </header>

                        <div class="chat-messages-container">
                            <div class="chat-messages" 
                                 x-ref="chatMessages"
                                 x-html="filteredMessages"></div>
                        </div>

                        <footer class="message-input-area">
                            <form class="message-form" @submit.prevent="sendMessage">
                                <div class="message-format-header">
                                    <div class="format-actions">
                                        <button type="button" class="format-button" title="Bold">
                                            <i class="fas fa-bold"></i>
                                        </button>
                                        <button type="button" class="format-button" title="Italic">
                                            <i class="fas fa-italic"></i>
                                        </button>
                                        <div class="format-divider"></div>
                                        <button type="button" class="format-button" title="Bullet List">
                                            <i class="fas fa-list-ul"></i>
                                        </button>
                                        <button type="button" class="format-button" title="Numbered List">
                                            <i class="fas fa-list-ol"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="message-input-wrapper">
                                    <textarea class="message-input" 
                                            x-model="messageContent" 
                                            @keydown.enter.exact.prevent="sendMessage" 
                                            placeholder="Type a message..."></textarea>
                                    <button type="submit" class="send-button" :disabled="!messageContent.trim()">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                                <div class="message-format-footer">
                                    <div class="format-actions">
                                        <button type="button" class="format-button" title="Add Emoji">
                                            <i class="far fa-smile"></i>
                                        </button>
                                        <button type="button" class="format-button" title="Mention Someone">
                                            <i class="fas fa-at"></i>
                                        </button>
                                    </div>
                                    
                                </div>
                            </form>
                        </footer>
                    </main>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Message Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true" x-data>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Delete Message') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>{{ _('Are you sure you want to delete this message? This action cannot be undone.') }}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                <button type="button" class="btn btn-danger" @click="$dispatch('delete-message')">{{ _('Delete') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Channel Modal -->
<div class="modal fade" id="deleteChannelModal" tabindex="-1" aria-hidden="true" x-data>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Delete Channel') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>{{ _('Are you sure you want to delete this channel? This action cannot be undone.') }}</p>
                <p class="text-danger">{{ _('All messages in this channel will be permanently deleted.') }}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                <button type="button" class="btn btn-danger" @click="$dispatch('delete-channel')">{{ _('Delete Channel') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- New Channel Modal -->
<div class="modal fade" id="newChannelModal" tabindex="-1" aria-labelledby="newChannelModalLabel" aria-hidden="true" 
     x-data="{ name: '', description: '', isPrivate: false, submit(e) { $dispatch('create-channel', { name: this.name, description: this.description, isPrivate: this.isPrivate }); } }">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newChannelModalLabel">{{ _('Create New Channel') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form @submit.prevent="submit">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="channel-name" class="form-label">{{ _('Channel Name') }}</label>
                        <input type="text" class="form-control" id="channel-name" x-model="name" required>
                        <small class="form-text text-muted">{{ _('Channel names can only contain lowercase letters, numbers, and hyphens.') }}</small>
                    </div>
                    <div class="mb-3">
                        <label for="channel-description" class="form-label">{{ _('Description') }}</label>
                        <textarea class="form-control" id="channel-description" x-model="description" rows="2"></textarea>
                    </div>
                    {% if current_user.is_admin %}
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="channel-private" x-model="isPrivate">
                        <label class="form-check-label" for="channel-private">{{ _('Private Channel') }}</label>
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-primary">{{ _('Create Channel') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Channel Modal -->
<div class="modal fade" id="editChannelModal" tabindex="-1" aria-labelledby="editChannelModalLabel" aria-hidden="true" 
     x-data="{ description: '', isPrivate: false, updateChannel(e) { $dispatch('update-channel', { description: this.description, isPrivate: this.isPrivate }); } }">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editChannelModalLabel">{{ _('Edit Channel') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form @submit.prevent="updateChannel">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit-description" class="form-label">{{ _('Description') }}</label>
                        <textarea class="form-control" id="edit-description" x-model="description" rows="2"></textarea>
                    </div>
                    {% if current_user.is_admin %}
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" x-model="isPrivate">
                        <label class="form-check-label">{{ _('Private Channel') }}</label>
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-primary">{{ _('Save Changes') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script src="{{ url_for('people_bp.static', filename='js/chat.js') }}"></script>
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
{% endblock %}

{% block additional_scripts %}{% endblock %}