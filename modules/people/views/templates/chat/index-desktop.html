{% extends "base-desktop.html" %}

{% block title %}{{ _('Company Chat') }}{% endblock %}

{% block app_class %}people-app{% endblock %}

{% block additional_styles %}
<link rel="stylesheet" href="{{ url_for('people_bp.static', filename='css/people.css') }}">
<link rel="stylesheet" href="{{ url_for('people_bp.static', filename='css/chat.css') }}">
{% endblock %}

{% block content %}
<div class="app-layout">
    {% include 'people_nav.html' with context %}
    
    <div class="app-content">
        <!-- Meta tags for initialization -->
        <meta name="user-id" content="{{ current_user.id }}">
        <meta name="default-channel" content="{{ default_channel.name }}">
        <meta name="default-channel-description" content="{{ default_channel.description }}">
        <meta name="api-urls" content='{{ {
            "create_message": url_for("people_bp.create_chat"),
            "create_channel": url_for("people_bp.create_channel"),
            "get_messages": url_for("people_bp.get_channel_messages", channel_name=":channel"),
            "mark_read": url_for("people_bp.mark_channel_read", channel_name=":channel"),
            "delete_message": "/people/chat/:id",
            "delete_channel": url_for("people_bp.delete_channel", channel_name=":channel"),
            "toggle_pin": "/people/chat/:id/pin"
        } | tojson | safe }}'>
        <meta name="channel-data" content='{"channels": [
            {% for channel in channels %}
            {
                "id": {{ channel.id }},
                "name": "{{ channel.name }}",
                "description": "{{ channel.description }}",
                "unreadCount": {{ ChatMessageState.get_unread_count(current_user.id, channel.id) }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ]}'>

        <div class="chat-container" 
             x-data="chatApp" 
             x-init="initializeApp()" 
             @delete-message.window="deleteMessage">
            <div class="chat-layout">
                <!-- Channel Sidebar -->
                <aside class="chat-sidebar">
                    <div class="sidebar-header">
                        <h3>{{ _('Channels') }}</h3>
                        {% if current_user.is_admin %}
                        <button class="btn btn-sm btn-link" data-bs-toggle="modal" data-bs-target="#newChannelModal">
                            <i class="fas fa-plus"></i>
                        </button>
                        {% endif %}
                    </div>

                    <div class="channel-list">
                        {% for channel in channels %}
                        <div class="channel" 
                             :class="{ 'active': currentChannel === '{{ channel.name }}' }"
                             x-data="{ id: {{ channel.id }}, name: '{{ channel.name }}' }">
                            <div class="channel-content" @click="switchChannel(name, id)">
                                <div class="channel-name">
                                    <span class="channel-prefix">#</span> {{ channel.name }}
                                </div>
                            </div>
                            <div class="channel-meta">
                                <span class="unread-badge" 
                                      x-show="getUnreadCount(id) > 0" 
                                      x-text="getUnreadCount(id)"></span>
                                {% if current_user.is_admin and channel.name != 'general' %}
                                <div class="channel-actions">
                                    <div class="dropdown" x-data="{ open: false }">
                                        <button class="btn btn-link btn-sm channel-options" 
                                                type="button" 
                                                @click.stop="open = !open"
                                                :aria-expanded="open">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end" 
                                            :class="{ 'show': open }" 
                                            @click.outside="open = false">
                                            <li><a class="dropdown-item" href="#" @click.prevent="editChannel(name, id); open = false">
                                                <i class="fas fa-edit me-2"></i>{{ _('Edit Channel') }}
                                            </a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-danger" href="#" @click.prevent="confirmDeleteChannel(name); open = false">
                                                <i class="fas fa-trash-alt me-2"></i>{{ _('Delete Channel') }}
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </aside>

                <!-- Main Chat Area -->
                <main class="chat-main">
                    <header class="chat-header">
                        <div class="chat-header-top">
                            <div class="chat-header-info">
                                <h2><span class="channel-prefix">#</span><span x-text="currentChannel"></span></h2>
                            </div>
                            <div class="chat-header-actions">
                                <button class="btn btn-link pin-filter" 
                                        :class="{ 'active': showPinnedOnly }"
                                        @click="togglePinFilter">
                                    <i class="fas fa-thumbtack"></i> {{ _('Pins') }}
                                    <span class="pin-count" x-text="pinnedMessagesCount" x-show="pinnedMessagesCount > 0"></span>
                                </button>
                                <div class="search-box">
                                    <i class="fas fa-search"></i>
                                    <input type="text" 
                                           x-model="searchQuery"
                                           placeholder="{{ _('Search messages...') }}" 
                                           class="form-control"
                                           @input="handleSearch">
                                </div>
                            </div>
                        </div>
                        <p class="channel-description" x-text="currentChannelDescription"></p>
                    </header>

                    <div class="chat-messages-container" 
                         x-ref="chatMessages"
                         @scroll.throttle="handleScroll">
                        <template x-for="message in messages" :key="message.id">
                            <div class="message" :class="{ 'pinned': message.is_pinned }">
                                <div class="message-header">
                                    <span class="author" x-text="message.author_name"></span>
                                    <span class="timestamp" x-text="message.created_at"></span>
                                    <div class="message-actions">
                                        <button class="btn btn-link btn-sm" @click="handleMessageAction('pin', message.id)" x-show="message.can_pin">
                                            <i class="fas" :class="message.is_pinned ? 'fa-thumbtack' : 'fa-thumbtack'"></i>
                                        </button>
                                        <button class="btn btn-link btn-sm text-danger" @click="handleMessageAction('delete', message.id)" x-show="message.can_delete">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="message-content" x-text="message.content"></div>
                            </div>
                        </template>
                    </div>

                    <footer class="message-input-area">
                        <form class="message-form" @submit.prevent="sendMessage">
                            <div class="message-input-wrapper">
                                <textarea class="message-input" x-model="messageContent" @keydown.enter.exact.prevent="sendMessage" placeholder="Type a message..."></textarea>
                                <button type="submit" class="send-button" :disabled="!messageContent.trim()">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </form>
                    </footer>
                </main>
            </div>
        </div>

        {% include 'chat/partials/modals.html' %}
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script src="{{ url_for('people_bp.static', filename='js/chat.js') }}"></script>
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
{% endblock %}